<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Register - Movies Ticket Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <style>
        .register-card {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            border-radius: 15px;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid white;
        }
        .step.active .step-circle {
            background: #007bff;
            color: white;
        }
        .step.completed .step-circle {
            background: #28a745;
            color: white;
        }
        .step-text {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }
        .step.active .step-text {
            color: #007bff;
            font-weight: 500;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-film me-2"></i>Movies Ticket Browser
        </a>
        <a href="/login" class="btn btn-outline-light btn-sm">
            <i class="fas fa-sign-in-alt me-1"></i>Login
        </a>
    </div>
</nav>

<div class="container-fluid bg-light min-vh-100 py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card register-card">
                <div class="card-body p-5">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                             style="width: 80px; height: 80px;">
                            <i class="fas fa-user-plus fa-2x text-white"></i>
                        </div>
                        <h2 class="fw-bold">Create Your Account</h2>
                        <p class="text-muted">Join thousands of movie enthusiasts and start booking today</p>
                    </div>

                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active" id="step1">
                            <div class="step-circle">1</div>
                            <div class="step-text">Personal Info</div>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-circle">2</div>
                            <div class="step-text">Account Details</div>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-circle">3</div>
                            <div class="step-text">Review</div>
                        </div>
                    </div>

                    <form th:action="@{/user/register}" method="post" id="registerForm">
                        <!-- Step 1: Personal Information -->
                        <div class="form-section active" id="section1">
                            <h5 class="mb-4 text-primary">
                                <i class="fas fa-user me-2"></i>Personal Information
                            </h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="name" name="name"
                                           placeholder="Enter your full name" required>
                                    <div class="form-text">As it appears on your ID</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="emailId" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="emailId" name="emailId"
                                           placeholder="Enter your email" required>
                                    <div class="form-text">We'll never share your email</div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="age" class="form-label">Age *</label>
                                    <input type="number" class="form-control" id="age" name="age"
                                           min="12" max="120" placeholder="Enter your age" required>
                                    <div class="form-text">Must be 12 years or older</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="gender" class="form-label">Gender *</label>
                                    <select class="form-select" id="gender" name="gender" required>
                                        <option value="">Select Gender</option>
                                        <option value="MALE">Male</option>
                                        <option value="FEMALE">Female</option>
                                        <option value="OTHER">Other</option>
                                        <option value="PREFER_NOT_TO_SAY">Prefer not to say</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label">Address *</label>
                                <textarea class="form-control" id="address" name="address"
                                          rows="3" placeholder="Enter your complete address" required></textarea>
                                <div class="form-text">Used for booking confirmations</div>
                            </div>

                            <div class="mb-4">
                                <label for="mobileNo" class="form-label">Mobile Number *</label>
                                <input type="tel" class="form-control" id="mobileNo" name="mobileNo"
                                       placeholder="Enter your 10-digit mobile number" required>
                                <div class="form-text">We'll send booking confirmations via SMS</div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <div></div>
                                <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                    Next <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Account Details -->
                        <div class="form-section" id="section2">
                            <h5 class="mb-4 text-primary">
                                <i class="fas fa-lock me-2"></i>Account Details
                            </h5>

                            <div class="mb-4">
                                <label for="roles" class="form-label">Account Type *</label>
                                <div class="row g-3">
                                    <div class="col-md-14">
                                        <div class="card account-type-card" data-role="ROLE_USER">
                                            <div class="card-body text-center">
                                                <i class="fas fa-user fa-2x text-primary mb-3"></i>
                                                <h6>Regular User</h6>
                                                <p class="text-muted small mb-0">
                                                    Book tickets, view history, and manage bookings
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="roles" name="roles" value="ROLE_USER" required>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">Create Password *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" name="password"
                                           placeholder="Create a strong password" required>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">Password must be at least 8 characters long</div>
                            </div>

                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label">Confirm Password *</label>
                                <input type="password" class="form-control" id="confirmPassword"
                                       placeholder="Confirm your password" required>
                                <div class="form-text" id="confirmPasswordFeedback"></div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary" onclick="prevStep(1)">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                    Next <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Review and Terms -->
                        <div class="form-section" id="section3">
                            <h5 class="mb-4 text-primary">
                                <i class="fas fa-clipboard-check me-2"></i>Review & Terms
                            </h5>

                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Review Your Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <strong>Personal Info</strong>
                                            <div id="reviewPersonal" class="text-muted small"></div>
                                        </div>
                                        <div class="col-sm-6">
                                            <strong>Account Details</strong>
                                            <div id="reviewAccount" class="text-muted small"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Terms & Conditions</label>
                                <div class="terms-box mb-3" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; max-height: 150px; overflow-y: auto; font-size: 12px; line-height: 1.4;">
                                    <h6>Movies Ticket Browser - Terms of Service</h6>
                                    <p>By creating an account, you agree to the following terms:</p>
                                    <ul>
                                        <li>You must be at least 12 years old to create an account</li>
                                        <li>You are responsible for maintaining the confidentiality of your account</li>
                                        <li>All ticket bookings are subject to theater policies and cancellation rules</li>
                                        <li>We reserve the right to refuse service to anyone for any reason at any time</li>
                                    </ul>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                    <label class="form-check-label" for="agreeTerms">
                                        I agree to the Terms of Service and Privacy Policy
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary" onclick="prevStep(2)">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-user-plus me-2"></i>Create Account
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="text-center mt-4 pt-3 border-top">
                        <p class="mb-0">Already have an account?
                            <a href="/login" class="text-decoration-none fw-bold">Sign in here</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;

    function nextStep(step) {
        if (!validateStep(currentStep)) return;

        document.getElementById(`section${currentStep}`).classList.remove('active');
        document.getElementById(`step${currentStep}`).classList.remove('active');

        currentStep = step;

        document.getElementById(`section${currentStep}`).classList.add('active');
        document.getElementById(`step${currentStep}`).classList.add('active');

        for (let i = 1; i < currentStep; i++) {
            document.getElementById(`step${i}`).classList.add('completed');
        }

        if (currentStep === 3) {
            updateReviewSection();
        }
    }

    function prevStep(step) {
        document.getElementById(`section${currentStep}`).classList.remove('active');
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`step${currentStep}`).classList.remove('completed');

        currentStep = step;

        document.getElementById(`section${currentStep}`).classList.add('active');
        document.getElementById(`step${currentStep}`).classList.add('active');
    }

    function validateStep(step) {
        switch (step) {
            case 1: return validatePersonalInfo();
            case 2: return validateAccountDetails();
            default: return true;
        }
    }

    function validatePersonalInfo() {
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('emailId').value.trim();
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const address = document.getElementById('address').value.trim();
        const mobile = document.getElementById('mobileNo').value.trim();

        if (!name) {
            alert('Please enter your full name');
            return false;
        }
        if (!email || !isValidEmail(email)) {
            alert('Please enter a valid email address');
            return false;
        }
        if (!age || age < 12 || age > 120) {
            alert('Please enter a valid age (12-120)');
            return false;
        }
        if (!gender) {
            alert('Please select your gender');
            return false;
        }
        if (!address || address.length < 10) {
            alert('Please enter a complete address');
            return false;
        }
        if (!mobile || !isValidMobile(mobile)) {
            alert('Please enter a valid 10-digit mobile number');
            return false;
        }
        return true;
    }

    function validateAccountDetails() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (password.length < 8) {
            alert('Password must be at least 8 characters long');
            return false;
        }
        if (password !== confirmPassword) {
            alert('Passwords do not match');
            return false;
        }
        return true;
    }

    function setupAccountTypeSelection() {
        const accountTypeCards = document.querySelectorAll('.account-type-card');
        accountTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                accountTypeCards.forEach(c => c.classList.remove('border-primary', 'bg-light'));
                this.classList.add('border-primary', 'bg-light');
                this.style.borderWidth = '2px';
                document.getElementById('roles').value = this.getAttribute('data-role');
                console.log('Selected role:', this.getAttribute('data-role'));
            });
        });
<!--        accountTypeCards[0].classList.add('border-primary', 'bg-light');-->
if (accountTypeCards.length > 0) {
        accountTypeCards[0].classList.add('border-primary', 'bg-light');
        accountTypeCards[0].style.borderWidth = '2px';
        document.getElementById('roles').value = accountTypeCards[0].getAttribute('data-role');
    }
    }

    function updateReviewSection() {
        const personalInfo = document.getElementById('reviewPersonal');
        const accountInfo = document.getElementById('reviewAccount');

        personalInfo.innerHTML = `
            ${document.getElementById('name').value}<br>
            ${document.getElementById('emailId').value}<br>
            Age: ${document.getElementById('age').value}<br>
            Gender: ${document.getElementById('gender').options[document.getElementById('gender').selectedIndex].text}<br>
            Mobile: ${document.getElementById('mobileNo').value}
        `;

        const role = document.getElementById('roles').value;
        accountInfo.innerHTML = `
            Account Type: ${role === 'ROLE_ADMIN' ? 'Administrator' : 'Regular User'}<br>
            Password: ••••••••
        `;
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function isValidMobile(mobile) {
        const mobileRegex = /^[6-9]\d{9}$/;
        return mobileRegex.test(mobile.replace(/\D/g, ''));
    }

    // Event listeners
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('password');
        const icon = this.querySelector('i');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    document.getElementById('mobileNo').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '').substring(0, 10);
    });
    document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission

    if (!validateStep(1) || !validateStep(2)) {
        alert('Please complete all required fields correctly.');
        return false;
    }
    if (!document.getElementById('agreeTerms').checked) {
        alert('Please agree to the Terms of Service to continue.');
        return false;
    }

    // Create JSON object from form data
    const userData = {
        name: document.getElementById('name').value,
        age: parseInt(document.getElementById('age').value),
        address: document.getElementById('address').value,
        mobileNo: document.getElementById('mobileNo').value,
        emailId: document.getElementById('emailId').value,
        gender: document.getElementById('gender').value,
        roles: document.getElementById('roles').value,
        password: document.getElementById('password').value
    };

    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Account...';
    submitBtn.disabled = true;

    // Send JSON request
    fetch('/user/addNew', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.text();
    })
    .then(result => {
        alert('Registration successful! You can now login.');
        window.location.href = '/login';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Registration failed: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

<!--    document.getElementById('registerForm').addEventListener('submit', function(e) {-->
<!--        if (!validateStep(1) || !validateStep(2)) {-->
<!--            e.preventDefault();-->
<!--            alert('Please complete all required fields correctly.');-->
<!--            return false;-->
<!--        }-->
<!--        if (!document.getElementById('agreeTerms').checked) {-->
<!--            e.preventDefault();-->
<!--            alert('Please agree to the Terms of Service to continue.');-->
<!--            return false;-->
<!--        }-->
<!--    });-->

<!--    // Initialize-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        setupAccountTypeSelection();-->
<!--    });-->
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>